<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ page isELIgnored="false" %>
<%
String path = request.getContextPath();
String basePath = request.getScheme()+"://"+request.getServerName()+":"+request.getServerPort()+path+"/";
%>

<!DOCTYPE>
<html>
  <head>
    <base href="<%=basePath%>">
    
    <title>学校管理</title>
  </head>
  
  <body>
  		<div fit="true" class="easyui-panel" border="false">
  			<!-- 学校新增 -->
		 	<div id="campus_add_dialog" class="easyui-dialog" title="新增学校" closed="true" modal="true" style="width:850px;height:auto;padding-top:20px;" iconCls="icon-building">
				<table id="campus_add_table" align="center" cellpadding="0"cellspacing="0" style="width: 90%;">
					<tr>
						<td colspan="6">
							<label style="font-size: 12px;color: #999d9c;">请先选择学校所在地区：</label>
						</td>
					</tr>
					<tr>
						<td style="padding: 10px 0px 0px 0px;">
							<label style="color: red;">*</label>
							<label style="font-size: 12px;">省:</label>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<select name="pccode" style="width: 150px; font-size:12px;" onchange="selectCityByPccodeCampusManage(this.value,'campus_add_table','请选择');">
								<option value="">--请选择--</option>
							</select>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<label style="color: red;">*</label>
							<label style="font-size: 12px;">市:</label>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<select name="ctcode" style="width: 150px;font-size:12px;" onchange="selectAreaByCtcodeCampusManage(this.value,'campus_add_table','请选择');">
								<option value="">--请选择--</option>
							</select>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<label style="color: red;">*</label>
							<label style="font-size: 12px;">县/区:</label>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<select name="aacode" style="width: 150px;font-size:12px;">
								<option value="">--请选择--</option>
							</select>
						</td>
					</tr>
					<tr>
						<td style="padding: 10px 0px 0px 0px;">
							<label style="color: red;">*</label>
							<label style="font-size: 12px;">学校名称:</label>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<input type="text" name="csname"/>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<label style="color: red;">*</label>
							<label style="font-size: 12px;">学校标识码:</label>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<input type="text" name="cscode"/>
						</td>
						
						<td style="padding: 10px 0px 0px 0px;">
							<label style="color: red;">*</label>
							<label style="font-size: 12px;">创办年份:</label>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
<!-- 							<input id="createyear" type="text" class="easyui-datebox" required="required"> -->
							<input type="text" name="createyear"/>
						</td>
					</tr>
					<tr>
						<td style="padding: 10px 0px 0px 0px;">
							<label style="color: red;">*</label>
							<label style="font-size: 12px;">学校别名:</label>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<input type="text" name="csotname"/>
						</td>
						
						<td style="padding: 10px 0px 0px 0px;">
							<label style="color: red;">*</label>
							<label style="font-size: 12px;">学校性质:</label>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<select name="csproerty" style="width: 150px;font-size:12px;">
								<option value="">--请选择--</option>
								<option value="1">公办学校</option>
								<option value="2">民办学校</option>
							</select>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<label style="color: red;">*</label>
							<label style="font-size: 12px;">学校地址:</label>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<input type="text" name="csaddres" value=""/>
						</td>
					</tr>
					
					<tr>
						<td style="padding: 10px 0px 0px 0px;" colspan="6">
							<label style="font-size: 12px;color: #999d9c;">(学校标识码是指由教育部按照国家标准及编码规则编制，赋予每一个学校（机构）在全国范围内唯一的、始终不变的识别标识码)</label>
						</td>
					</tr>
					<tr>
						<td style="padding: 10px 0px 0px 0px;">
							<label style="color: red;">*</label>
							<label style="font-size: 12px;">学校电话:</label>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<input type="text" name="cstelnum"/>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<label style="color: red;">*</label>
							<label style="font-size: 12px;">校长姓名:</label>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<input type="text" name="principal"/>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<label style="color: red;">*</label>
							<label style="font-size: 12px;">校长联系电话:</label>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<input type="text" name="prnum"/>
						</td>
					</tr>
					<tr>
						<td style="padding: 10px 0px 0px 0px;">
							<label style="font-size: 12px;">分管领导姓名:</label>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<input type="text" name="charger"/>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<label style="font-size: 12px;">分管领导职务:</label>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<input type="text" name="chagejob"/>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<label style="font-size: 12px;">分管领导电话:</label>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<input type="text" name="chrgtelnum"/>
						</td>
					</tr>
					
					<tr>
						
					</tr>
					<tr>
						<td style="padding: 10px 0px 0px 0px;">
							<label style="font-size: 12px;">电子邮箱:</label>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<input type="text" name="email" value=""/>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<label style="font-size: 12px;">邮政编码:</label>
						</td>
						<td style="padding: 10px 0px 0px 0px;">
							<input type="text" name="postcode" value=""/>
						</td>
					</tr>
					<tr>
						<td>
							<label style="font-size: 12px;">学校简介:</label>
						</td>
						<td colspan="5" style="padding: 10px 0px 0px 0px;" align="center">
							<textarea name="csintro" style="font-size: 12px;width: 550px;height: 100px;resize: none;"></textarea>
						</td>
					</tr>
					<tr>
						<td style="padding: 10px 0px 0px 0px;" colspan="6" align="center">
							<a href="javascript:void(0);" class="easyui-linkbutton" iconCls="icon-save" onclick="campus_add();">保存</a>
							<a href="javascript:void(0);" class="easyui-linkbutton" iconCls="icon-cancel" style="margin-left: 10px;" onclick="dialog_close('campus_add_dialog');">关闭</a>
						</td>
					</tr>
					<tr style="height: 10px;">
					</tr>
				</table>
			</div>
			
  		
  			<!-- 搜索及数据展示 -->
			<div id="campus_search_div" style="height:auto;min-height:1px;float: left;line-height: 35px;width: 100%;">
			
				<!-- 超级管理员搜索框 -->
				<div style="float: left;padding: 5px 5px;height: 35px;">
					<label style="font-size: 12px;">省:</label>
					<select name="pccode" style="width: 150px;" onchange="selectCityByPeidCampusManage(this.value,'campus_search_div','全部');">
						<option value="">--全部--</option>
					</select>
				</div>
				<div style="float: left;padding: 5px 5px;height: 35px;">
					<label style="font-size: 12px;">市:</label>
					<select name="ctcode" style="width: 150px;" onchange="selectAreaByCyidCampusManage(this.value,'campus_search_div','全部');">
						<option value="">--全部--</option>
					</select>
				</div>
				<div style="float: left;padding: 5px 5px;height: 35px;">
					<label style="font-size: 12px;">县/区:</label>
					<select name="aacode" style="width: 150px;" onchange="selectTownByAaidCampusManage(this.value,'campus_search_div','全部');">
						<option value="">--全部--</option>
					</select>
				</div>
				<div style="float: left;padding: 5px 5px;height: 35px;">
					<label style="font-size: 12px;">学校名称:</label>
					<input type="text" name ="csname"/>
				</div>
				<div style="float: left;padding: 8px 5px;">
					<a href="javascript:void(0);" title="快捷键(Enter)" class="easyui-linkbutton" iconCls="icon-search" onclick="campus_search();">搜索</a>
				</div>
				<div style="float: left;padding: 8px 5px;">
					<a href="javascript:void(0);" class="easyui-linkbutton" iconCls="icon-add" onclick="campus_add_dialog_open();">新增</a>
				</div>
				<div style="float: left;padding: 8px 5px;">
					<a href="javascript:void(0);" class="easyui-linkbutton" iconCls="icon-cancel" onclick="campus_delBat();">批量删除</a>
				</div>
				<div style="float: left;padding: 8px 5px;">
					<a href="javascript:void(0);" class="easyui-linkbutton" iconCls="icon-page_excel" onclick="campus_search_exp();">搜索导出</a>
				</div>
				<div style="float: left;padding: 8px 5px;">
					<a href="javascript:void(0);" class="easyui-linkbutton" iconCls="icon-building_add" onclick="open_campus_imp();">学校导入</a>
				</div>
			</div>
			<table id="campus_datagrid_table"></table>
			
  			
  			
  			<!-- 学校导入 -->
  			<div id="campus_imp_dialog" class="easyui-dialog" title="学校导入" closed="true" modal="true" style="width:500px;height:290px;" iconCls="icon-building_add">
  				<form id="campus_imp_form" method="post" enctype="multipart/form-data">
	  				<table style="width: 100%;padding: 20px 0px 0px 0px;">
	  					<tr>
							<td style="padding: 10px 0px 0px 5px;" align="left" colspan="2">
								<label style="font-size: 12px;font-weight: bold;">注意:</label>&nbsp;&nbsp;
							</td>
						</tr>
						<tr>
							<td style="padding: 5px 0px 0px 10px;" align="left" colspan="2">
								<label style="font-size: 12px;">[1]请严格按照导入模版进行操作。</label>
								<a href="javascript:void(0);" onclick="down_campus_imp_mode();" style="font-size: 12px;text-decoration: none;">>>点击下载导入模版</a>
							</td>
						</tr>
						<tr>
							<td style="padding: 5px 0px 0px 10px;" align="left" colspan="2">
								<label style="font-size: 12px;">[2]在EXCEL导入模版中红色标记的列为必填列。</label>
							</td>
						</tr>
						<tr>
							<td style="padding: 20px 0px 0px 0px;" align="right">
								<label style="font-size: 12px;font-weight: bold;">选择EXCEL:</label>&nbsp;&nbsp;
							</td>
							<td style="padding: 20px 0px 0px 0px;">
								<input type="file" name="csfile"/>
							</td>
						</tr>
						<tr>
							<td style="padding: 10px 0px;" colspan="2" align="center">
								<a href="javascript:void(0);" class="easyui-linkbutton" iconCls="icon-save" onclick="submit_campus_imp();">保存</a>
							</td>
						</tr>
					</table>
				</form>
			</div>
		</div>
		<script type="text/javascript">
			//页面加载完成
			$(document).ready(function(){
				//绑定回车搜索事件
				document.onkeydown = function(e){
					var ev = document.all ? window.event : e;
					if(ev.keyCode==13){
						campus_search();
					}
				};
				
				//提取所有省数据
  				$.ajax({
					url:"findAllProvince_campus.htm",
					type:"post",
					success:function(r){
						r=$.parseJSON(r);
						var html="<option value=''>--全部--</option>";
						for(var i=0;i<r.length;i++){
							html+="<option value='"+r[i].pccode+"'>"+r[i].pcname+"</option>";
						}
						$("#campus_search_div select[name='pccode']").html(html);
					},
					error:function(){
						$.messager.alert("系统提示","服务器连接失败","error");
					}
				});
				// 加载表格数据
				$('#campus_datagrid_table').datagrid({
					title :'', 
					fit : true,
					url : 'findListCount_campus.htm',
					queryParams : {
// 						pccode : pccode,
// 						ctcode : ctcode,
// 						aacode : aacode,
// 						csname : csname
					},
					pageSize : 25,
					pageList : [25,50,75,100],
					singleSelect :false,
					rownumbers : true,
					pagination : true,
					iconCls : 'icon-save',
					fitColumns :true,
					toolbar:'#campus_search_div',
					columns : [[
						{field:'text',title:'',width:120,align:'center',checkbox:true},
						{field:'csid',title:'操作',width:130,align:'center',
							formatter:function(value,rowData,rowIndex){
								if(value!=undefined && value!=""){
									var html="";
									html+="<div class='rowButton_select' title='查看' onclick=\"javascript:campus_select_dialog_open('"+value+"');\"></div>";
									html+="<div class='rowButton_edit' title='编辑' onclick=\"javascript:campus_edit_dialog_open('"+value+"');\"></div>";
									html+="<div class='rowButton_delete' title='删除' onclick=\"javascript:campus_del('"+value+"');\"></div>";
									html+="<div class='rowButton_xuexiaozhanghu' title='学校帐号' onclick=\"javascript:campus_users_dialog_open('"+value+"');\"></div>";
							   		return html;
						   		}
							}
						},
						{field:'dq',title:'地区',width:120,align:'center',
							formatter: function(value,row,index){  
						   	if(value!=undefined && value!=""){
								return "<span title="+value+">"+value+"</span>"  ;
							}
						}},
						{field:'csname',title:'学校名称',width:120,align:'center',
							formatter: function(value,row,index){  
						   	if(value!=undefined && value!=""){
								return "<span title="+value+">"+value+"</span>"  ;
							}
						}},
						{field:'csotname',title:'学校别名',width:80,align:'center',
							formatter: function(value,row,index){  
						   	if(value!=undefined && value!=""){
								return "<span title="+value+">"+value+"</span>"  ;
							}
						}},
						{field:'cscode',title:'学校标识码',width:120,align:'center'},
						{field:'cstelnum',title:'学校电话',width:120,align:'center'},
						{field:'csaddres',title:'学校地址',width:120,align:'center',
							formatter: function(value,row,index){  
						   	if(value!=undefined && value!=""){
								return "<span title="+value+">"+value+"</span>"  ;
							}
						}},
						{field:'principal',title:'校长',width:80,align:'center'},
						{field:'prnum',title:'校长电话',width:120,align:'center'},
						{field:'email',title:'电子邮箱',width:120,align:'center'},
						{field:'postcode',title:'邮政编码',width:120,align:'center'}
					]],
					// 双击事件
					onDblClickRow:function (rowIndex, rowData){
						campus_select_dialog_open(rowData.CSID);
					},
					// 加载成功
					onLoadSuccess : function () {
						$(this).datagrid("fixRownumber");
					}
				});
			});
		
		
		
			// 打开新增学校的窗口
			function campus_add_dialog_open(){
				//清空里面的值
				$("#campus_add_table input").each(function(){
					$(this).val("");
				});
				$("#campus_add_table select[name='csproerty']").val("");
				$("#campus_add_table select[name='ctcode']").val("");
				$("#campus_add_table select[name='aacode']").val("");
				//提取所有省数据
				$.ajax({
					url:"findAllProvince_campus.htm",
					type:"post",
					success:function(r){
						r=$.parseJSON(r);
						var html="<option value=''style=\"color:#919191; font-size:14px;\">--请选择--</option>";
						for(var i=0;i<r.length;i++){
							html+="<option value='"+r[i].pccode+"'>"+r[i].pcname+"</option>";
						}
						$("#campus_add_table select[name='pccode']").html(html);
					},
					error:function(){
  						$.messager.alert("系统提示","服务器连接失败","error");
  					}
				});
				//打开窗口
				$("#campus_add_dialog").dialog("open");
			}
			
			
			
			
			// 根据省数据加载市数据
			function selectCityByPccodeCampusManage(pccode,xrdiv,tl){
				//校验
				if(pccode==null || $.trim(pccode).length<=0){
  					$("#"+xrdiv+" select[name='ccode']").html("<option value=''>--"+tl+"--</option>");
  					$("#"+xrdiv+" select[name='aaid']").html("<option value=''>--"+tl+"--</option>");
  					return;
  				}
				$.ajax({
					url:"findCityByPccode_campus.htm",
					type:"post",
					data:{
						pccode : pccode
					},
					success:function(r){
						r=$.parseJSON(r);
						var hl="<option value=''>--"+tl+"--</option>";
						for(var k=0;k<r.length;k++){
							hl+="<option value='"+r[k].ctcode+"'>"+r[k].ctname+"</option>";
						}
						$("#"+xrdiv+" select[name='ctcode']").html(hl);
						$("#"+xrdiv+" select[name='aacode']").html("<option value=''>--"+tl+"--</option>");
					},
					error:function(){
						$.messager.alert("系统提示","服务器连接失败","error");
					}
				});
			}
			
			
			
			
			
			//根据市编码查询县区数据
			function selectAreaByCtcodeCampusManage(ctcode,xrdiv,tl){
				//校验
				if(ctcode==null || $.trim(ctcode).length<=0){
  					$("#"+xrdiv+" select[name='aacode']").html("<option value=''>--"+tl+"--</option>");
  					return;
  				}
				$.ajax({
					url:"findAreaByCtcode_campus.htm",
					type:"post",
					data:{
						ctcode : ctcode
					},
					success:function(r){
						r=$.parseJSON(r);
						var hl="<option value=''>--"+tl+"--</option>";
						for(var k=0;k<r.length;k++){
							hl+="<option value='"+r[k].aacode+"'>"+r[k].aaname+"</option>";
						}
						$("#"+xrdiv+" select[name='aacode']").html(hl);
					},
					error:function(){
						$.messager.alert("系统提示","服务器连接失败","error");
					}
				});
			}
			
			
			
			
			
			//新增学校数据
			function campus_add(){
				//省
  				var pccode=$("#campus_add_table select[name='pccode']").val();
  				if(pccode==null || pccode==""){
  					$.messager.alert("系统提示","请选择所在省","warning");
  					return;
  				}
  				//市
  				var ctcode=$("#campus_add_table select[name='ctcode']").val();
  				if(ctcode==null || ctcode==""){
  					$.messager.alert("系统提示","请选择所在市","warning");
  					return;
  				}
  				//县区
  				var aacode=$("#campus_add_table select[name='aacode']").val();
  				if(aacode==null || aacode==""){
  					$.messager.alert("系统提示","请选择所在县/区","warning");
  					return;
  				}
  				
  				//学校名称
  				var csname=$("#campus_add_table input[name='csname']").val();
  				if(csname==null || $.trim(csname).length<=0){
  					$.messager.alert("系统提示","请填写学校名称","warning");
  					return;
  				}
  				//学校标识码
  				var cscode=$("#campus_add_table input[name='cscode']").val();
  				if(cscode==null || $.trim(cscode).length<=0){
  					$.messager.alert("系统提示","请填写学校标识码","warning");
  					return;
  				}
  				
  				// 创办年份
  				var createyear=$("#campus_add_table input[name='createyear']").val();
  				if(createyear==null || $.trim(createyear).length<=0){
  					$.messager.alert("系统提示","请填写年份","warning");
  					return;
  				}
  				
  				//学校别名
  				var csotname=$("#campus_add_table input[name='csotname']").val();
  				if(csotname==null || $.trim(csotname).length<=0){
  					$.messager.alert("系统提示","请填写学校别名","warning");
  					return;
  				}
  				
  				//学校性质
  				var csproerty=$("#campus_add_table select[name='csproerty']").val();
  				if(csproerty==null || $.trim(csproerty).length<=0){
  					$.messager.alert("系统提示","请选择学校性质","warning");
  					return;
  				}
  				
  				//学校地址
  				var csaddres=$("#campus_add_table input[name='csaddres']").val();
  				if(csaddres==null || $.trim(csaddres).length<=0){
  					$.messager.alert("系统提示","请填写学校地址","warning");
  					return;
  				}
  				
  				//学校电话
  				var cstelnum=$("#campus_add_table input[name='cstelnum']").val();
  				if(cstelnum==null || $.trim(cstelnum).length<=0){
  					$.messager.alert("系统提示","请填写学校电话","warning");
  					return;
  				}
  				
  				//校长姓名
  				var principal=$("#campus_add_table input[name='principal']").val();
  				if(principal==null || $.trim(principal).length<=0){
  					$.messager.alert("系统提示","请填写校长姓名","warning");
  					return;
  				}
  				
  				//校长联系电话
  				var prnum=$("#campus_add_table input[name='prnum']").val();
  				if(prnum==null || $.trim(prnum).length<=0){
  					$.messager.alert("系统提示","请填写校长联系电话","warning");
  					return;
  				}
  				
  				//分管领导姓名
  				var charger=$("#campus_add_table input[name='charger']").val();
  				//分管领导职务
  				var chagejob=$("#campus_add_table input[name='chagejob']").val();
  				//分管领导电话
  				var chrgtelnum=$("#campus_add_table input[name='chrgtelnum']").val();
  				
  				//电子邮箱
  				var email=$("#campus_add_table input[name='email']").val();
  				if($.trim(email).length>0){
  					var reg =/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/;
  					if(!reg.test(email)){
  						$.messager.alert("系统提示","请正确填写邮箱,格式为XXXX@XX.XX","warning");
  						return;
  					}
  				}
  				//邮政编码
  				var postcode=$("#campus_add_table input[name='postcode']").val();
  				//学校简介
  				var csintro=$("#campus_add_table textarea[name='csintro']").val();
  				$.messager.progress({title:"系统提示",msg:"数据保存中,请稍等..."});
  				$.ajax({
  					url : "addCampusData.htm",
  					type:"post",
  					data:{
  						pccode : pccode,
  						ctcode : ctcode,
  						aacode : aacode,
  						csname : csname,
  						cscode : cscode,
  						createyear : createyear,
  						csotname : csotname,
  						csproerty : csproerty,
  						csaddres : csaddres,
  						cstelnum : cstelnum,
  						principal : principal,
  						prnum : prnum,
  						charger : charger,
  						chagejob : chagejob,
  						chrgtelnum : chrgtelnum,
  						email : email,
  						postcode : postcode,
  						csintro : csintro
  					},
  					success:function(r){
  						$.messager.progress('close');
						r=$.parseJSON(r);
						if(r.result=="502"){
							$("#campus_add_dialog").dialog("close");
							$.messager.alert("系统提示",r.msg,"makegood");
	  					}else{
							$.messager.alert("系统提示",r.msg,"error");
						}
  					},
  					error:function(){
  						$.messager.progress('close');
						$.messager.alert("系统提示","服务器连接失败","error");
  					}
  				});
			}
			
			
			// 关闭事件
			function dialog_close(id){
				$("#"+id).dialog("close");
			}
			
			
			//搜索导出
			function campus_search_exp(){
				var pccode = $("#campus_search_div select[name='pccode']").val();
				if(pccode=="undefined" || pccode==undefined){
					pccode="";
				}
				var	ctcode = $("#campus_search_div select[name='ctcode']").val();
				if(ctcode=="undefined" || ctcode==undefined){
					ctcode="";
				}
				var	aacode = $("#campus_search_div select[name='aacode']").val();
				if(aacode=="undefined" || aacode==undefined){
					aacode="";
				}
				var	csname = $("#campus_search_div input[name='csname']").val();
				if(csname=="undefined" || csname==undefined){
					csname="";
				}
				// 搜索导出请求地址
				var url="list_campusnew_exp.htm?csname="+csname+"&pccode="+pccode+"&ctcode="+ctcode+"&aacode="+aacode;
				window.open(url);
			}
			
		</script>
	</body>
</html>
